# Телеграм Бот для Прогнозов на Спортивные Матчи

Этот бот анализирует сообщения от пользователей с информацией о предстоящих матчах, собирает информацию о командах и генерирует прогнозы на матчи с использованием OpenAI API.

## Функциональность

- Обрабатывает сообщения в специальном формате (или с префиксом "@Get articles")
- Ищет информацию о командах и последних матчах в интернете
- Генерирует подробные прогнозы на матчи с учетом минимального количества символов
- Автоматически обрабатывает записи "Все X матчей" путем поиска информации о предстоящих матчах в указанном турнире
- Поддерживает ограничение количества статей (например, "5 статей")
- Имеет команду `/cancel` для отмены обработки текущих запросов

## Установка

1. Клонируйте репозиторий
2. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```
3. Создайте файл `.env` на основе `.env.example` и добавьте свои ключи API:
   ```
   TELEGRAM_BOT_TOKEN=ваш_токен_бота
   OPENAI_API_KEY=ваш_ключ_openai
   APP_URL=ваш_url_приложения
   WEBHOOK_PATH=ваш_секретный_путь_webhook
   ```

## Использование

1. Запустите бота:
   ```
   python bot.py
   ```
2. В Telegram, отправьте боту сообщение в формате:
   ```
   на [дата] (не позднее [дедлайн])
   
   1. [Команда1] - [Команда2]                [Турнир] ([мин_символов])
   2. [Все X матчей]                [Турнир] ([мин_символов])
   ...
   ```
   
   Или можно использовать упрощенный формат:
   ```
   5 статей
   Спартак - ЦСКА
   Барселона - Реал Мадрид
   ```

3. Бот обработает сообщение и начнет генерировать прогнозы
4. Для отмены обработки используйте команду `/cancel`

## Деплой на Render

1. Создайте аккаунт на [Render](https://render.com/)
2. Подключите ваш GitHub репозиторий
3. Создайте новый веб-сервис, выбрав репозиторий
4. В разделе настроек укажите:
   - **Environment**: Python
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `python bot.py`
5. Добавьте переменные окружения:
   - `TELEGRAM_BOT_TOKEN`: ваш токен от BotFather
   - `OPENAI_API_KEY`: ваш ключ API OpenAI
   - `APP_URL`: URL вашего приложения на Render (например, https://telegram-sportarticles-bot.onrender.com)
   - `WEBHOOK_PATH`: уникальный секретный путь для webhook (если не указан, будет сгенерирован автоматически)
6. Нажмите "Create Web Service"
7. После успешного деплоя, откройте URL `/set_webhook` для активации вебхука бота

## Локальная разработка

Для локального запуска в режиме polling добавьте переменную окружения:
```
USE_POLLING=true
```

## Безопасность

В боте реализованы следующие меры безопасности:

1. **Защита от DoS атак**:
   - Ограничение количества запросов от одного пользователя
   - Ограничение размера входных данных
   - Таймауты для внешних API запросов

2. **Защита веб-хука**:
   - Использование секретного пути для webhook
   - Проверка входящих запросов на соответствие формату Telegram
   - Логирование IP-адресов источников запросов

3. **Защита от инъекций**:
   - Валидация и санитизация всех входящих данных
   - Безопасная обработка параметров API запросов
   - Защита от ReDoS уязвимостей в регулярных выражениях

4. **Управление зависимостями**:
   - Использование безопасных версий библиотек
   - Регулярное обновление зависимостей для исправления уязвимостей

5. **Защита API ключей**:
   - Хранение чувствительных данных в переменных окружения
   - Проверка наличия и валидности ключей при запуске

## Примечания по реализации

- Поиск информации о матчах реализован через модуль `web_search.py` с защитой от злоупотреблений API
- Для генерации прогнозов используется OpenAI API (**gpt-3.5-turbo**)
- Бот настроен для обработки как конкретных матчей, так и целых турниров
- Имеется механизм отмены и ограничения количества запросов для защиты от спама

## Требования
- Python 3.9+
- Токен Telegram бота
- Ключ API OpenAI 